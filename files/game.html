<!DOCTYPE html>
<html lang="en">
	<head>
		<title>worlds</title>
		<link href="https://fonts.googleapis.com/css?family=VT323&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="/style.css">
		<script src="/game/game.js"></script>
		<script defer src="/game/tileinfo.js"></script>
		<script defer src="/game/map.js"></script>
		<script defer src="/game/stats.js"></script>
		<script defer src="/game/players.js"></script>
		<script defer src="/game/diplomacy.js"></script>
		<meta charset="utf8">
	</head>
	<body>
		<w-map id="earth" width="48" height="48" style="display:block;margin:64px auto"></w-map> 
		<w-map style="display:none;margin:64px auto;" id="mars" width="24" height="24"></w-map> 

		<button style="position:fixed;top:32px;left:0;right:0;margin:auto;width:100px;z-index:4;display:none" id="switch">To Mars</button>

		<w-tileinfo style="position:fixed;left:32px;bottom:32px;width:250px;height:150px;z-index:3"></w-tileinfo>
		<w-stats id="stats" style="position:fixed;left:32px;top:32px;z-index:3;"></w-stats>
		<w-stats id="materials" style="position:fixed;left:32px;top:128px;z-index:3;"></w-stats>
		<w-players id="players" style="position:fixed;right:32px;top:32px;z-index:3"></w-players>
		<w-diplomacy id="diplomacy" style="position:fixed;right:32px;bottom:32px;z-index:3"></w-diplomacy>

		<script>
const playersElem = document.getElementById("players");
const diplomacyElem = document.getElementById("diplomacy");
const marsElem = document.getElementById("mars");
const earthElem = document.getElementById("earth");

function tileAt(i) {
	if (i >= 48*48) {
		return marsElem.tileAt(i - 48*48);
	}
	return earthElem.tileAt(i);
}

let ws = new WebSocket(
	(location.protocol == "https:" ? "wss" : "ws") + "://" + location.host + "/api/gamews");

const roomId = location.pathname.split("/")[1];
const userKey = location.hash.slice(1).split(":")[0];
let playerIndex;
let players = [];

const stats = document.getElementById("stats");
const materials = document.getElementById("materials");

let relationships = [];

ws.onmessage = function(msg) {
	let data = JSON.parse(msg.data);
	switch (data[0]) {
	case "error":
		console.error(data[1]);
		break;
	case "start":
		players = data[1].players;
		playerIndex = data[1].playerIndex;
		stats.add("Turn");
		stats.add("P");

		materials.add("Brk", "text-brick");
		materials.add("Cu", "text-copper");
		materials.add("Fe", "text-iron");
		materials.add("Au", "text-gold");
		materials.add("U", "text-uranium");

		playersElem.setPlayers(players, playerIndex);
		break;
	case "update":
		for (let i = 0; i < 48*48+24*24; i++) {
			const tile = tileAt(i);
			tile.setAttribute("tiletype", data[1].tiletypes[i]);
			tile.setAttribute("territory", data[1].territory[i]);
			tile.setAttribute("terrain", data[1].terrain[i]);
			tile.setAttribute("deposit", data[1].deposits[i]);
			tile.setAttribute("army", data[1].armies[i]);
		}
		stats.set("Turn", data[1].turn);
		stats.set("P", data[1].pollution);
		materials.set("Brk", (data[1].amounts[playerIndex].brick | 0) + " / " + (data[1].capacity.brick|0));
		materials.set("Cu", (data[1].amounts[playerIndex].copper | 0) + " / " + (data[1].capacity.copper|0));
		materials.set("Fe", (data[1].amounts[playerIndex].iron | 0) + " / " + (data[1].capacity.iron|0));
		materials.set("Au", (data[1].amounts[playerIndex].gold | 0) + " / " + (data[1].capacity.gold|0));
		materials.set("U", (data[1].amounts[playerIndex].uranium | 0) + " / " + (data[1].capacity.uranium|0));
		if (data[1].amounts[playerIndex].green > 0) {
			materials.add("G", "text-green");
			materials.set("G", (data[1].amounts[playerIndex].green | 0) + " / " + (data[1].capacity.green|0));
		}
		playersElem.setLosers(data[1].losers || []);
		playersElem.setStats(data[1].stats);
		playersElem.setRelationships(data[1].relationships);

		diplomacyElem.setRequests(players, data[1].relationships, data[1].requests);
		for (let i = 0; i < relationships.length; i++) {
			if (relationships[i] >= 0 && data[1].relationships[i] < 0) {
				diplomacyElem.addWar(i, players[i]);
			}
		}

		relationships = data[1].relationships;
		break;
	}
}

ws.onopen = function() {
	ws.send(JSON.stringify(["join", {id: roomId, key: userKey}]));
}

earthElem.addEventListener("move", function(e) {
	ws.send(JSON.stringify(["move", {id: roomId, from: e.detail.from, to: e.detail.to}]));
});
earthElem.addEventListener("nuke", function(e) {
	ws.send(JSON.stringify(["nuke", {id: roomId, tile: e.detail}]));
});
earthElem.addEventListener("launch", function(e) {
	if (tileAt(e.detail).getAttribute("tiletype") == "launcher") {
		document.getElementById("switch").style.display = "inline-block";
		document.getElementById("switch").click();
	}

	ws.send(JSON.stringify(["launch", {id: roomId, tile: e.detail}]));
});
earthElem.addEventListener("delete", function(e) {
	for (let tile of e.detail) {
		ws.send(JSON.stringify(["make", {id: roomId, tile: tile, type: ""}]));
	}
});
marsElem.addEventListener("move", function(e) {
	ws.send(JSON.stringify(["move", {id: roomId, from: e.detail.from+48*48, to: e.detail.to+48*48}]));
});
marsElem.addEventListener("nuke", function(e) {
	ws.send(JSON.stringify(["nuke", {id: roomId, tile: e.detail+48*48}]));
});
marsElem.addEventListener("launch", function(e) {
	ws.send(JSON.stringify(["launch", {id: roomId, tile: e.detail+48*48}]));
});
marsElem.addEventListener("delete", function(e) {
	for (let tile of e.detail) {
		ws.send(JSON.stringify(["make", {id: roomId, tile: tile+48*48, type: ""}]));
	}
});

let activeMap = earthElem;
document.getElementById("switch").addEventListener("click", function() {
	activeMap.style.display = "none";
	if (activeMap.id == "earth") {
		this.innerHTML = "To Earth";
		activeMap = marsElem;
		document.body.style.background = "#993354";
	} else {
		this.innerHTML = "To Mars";
		activeMap = earthElem;
		document.body.style.background = "#3F6ABF";
	}
	activeMap.style.display = "block";
});

document.querySelector("w-tileinfo").addEventListener("make", function(e) {
	let tiles = activeMap.selected();
	if (activeMap.id == "mars")
		tiles = tiles.map(t => t + 48*48);

	for (let tile of tiles) {
		ws.send(JSON.stringify(["make", {id: roomId, tile: tile, type: e.detail}]));
	}
});

playersElem.addEventListener("relationship", function(e) {
	ws.send(JSON.stringify(["relationship", {id:roomId,upgrade:e.detail.action == "increase", player:e.detail.player}]));
});

diplomacyElem.addEventListener("accept", function(e) {
	ws.send(JSON.stringify(["relationship", {id:roomId, upgrade:true, player: e.detail}]));
});
		</script>
	</body>
</html>
