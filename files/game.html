<!DOCTYPE html>
<html lang="en">
	<head>
		<title>worlds &#8226; earth</title>
		<link href="https://fonts.googleapis.com/css?family=VT323&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="/style.css">
		<script defer src="/game/tile.js"></script>
		<script defer src="/game/map.js"></script>
	</head>
	<body>
		<w-map id="earth" width="48" height="48"></w-map> 
		<w-map style="display:none" id="mars" width="24" height="24"></w-map> 

		<script>
function tileAt(i) {
	if (i >= 48*48) {
		return document.getElementById("mars").tileAt(i - 48*48);
	}
	return document.getElementById("earth").tileAt(i);
}

let ws = new WebSocket(
	(location.protocl == "https:" ? "wss" : "ws") + "://" + location.host + "/api/gamews");

const roomId = location.pathname.split("/")[1];
const userKey = location.hash.slice(1).split(":")[0];
let players = [];

ws.onmessage = function(msg) {
	let data = JSON.parse(msg.data);
	switch (data[0]) {
	case "error":
		console.error(data[1]);
		break;
	case "start":
		players = data[1].players;
		break;
	case "update":
		for (let i = 0; i < 48*48+24*24; i++) {
			const tile = tileAt(i);
			tile.setAttribute("tiletype", data[1].tiletypes[i]);
			tile.setAttribute("territory", data[1].territory[i]);
			tile.setAttribute("terrain", data[1].terrain[i]);
			tile.setAttribute("deposit", data[1].deposits[i]);
			tile.setAttribute("army", data[1].armies[i]);
		}
	}
}

ws.onopen = function() {
	ws.send(JSON.stringify(["join", {id: roomId, key: userKey}]));
}

document.getElementById("earth").addEventListener("move", function(e) {
	ws.send(JSON.stringify(["move", {id: roomId, from: e.detail.from, to: e.detail.to}]));
});
document.getElementById("mars").addEventListener("move", function(e) {
	ws.send(JSON.stringify(["move", {id: roomId, from: e.detail.from+48*48, to: e.detail.to+48*48}]));
});
		</script>
	</body>
</html>
