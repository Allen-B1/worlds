<!DOCTYPE html>
<html lang="en">
	<head>
		<title>worlds</title>
		<link href="https://fonts.googleapis.com/css?family=VT323&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="/style.css">
	</head>
	<body>
		<div class="card">
			<p>You are <b id="name">Anonymous</b></p>
			<p><b id="count">0</b> of <b id="max">0</b></p>
			<p><b>Fog of War</b>: <span id="fog">On</span></p>
			<a class="button" href="/">Back</a>
		</div>
		<script>
document.body.style.display = "none";

const roomId = location.pathname.split("/")[1];
var userId = null;
var name = prompt("What is your name?");
if (name == "" || name == null) {
	location.href = "/";
}
{
	var xhr = new XMLHttpRequest();
	xhr.addEventListener("load", function() {
		userId = xhr.responseText;
		document.body.style.display = "block";
	});
	xhr.open("POST", "/api/" + roomId + "/join?name=" + name);
	xhr.send();
}

var countElem = document.getElementById("count");
var maxElem = document.getElementById("max");
var nameElem = document.getElementById("name");
var fogElem = document.getElementById("fog");

nameElem.innerHTML = name;

function req() {
	var xhr = new XMLHttpRequest();
	xhr.addEventListener("load", function() {
		var json = JSON.parse(xhr.responseText);
		if (json.type != "room") {
			if (userId != null)
				location.href = "/" + roomId + "/game#" + userId;
		} else {
			countElem.innerHTML = json.players.length;
			maxElem.innerHTML = json.max;
			fogElem.innerHTML = json.fog ? "On" : "Off";
		}
	});
	xhr.open("GET", "/api/" + roomId + "/data.json");
	xhr.send();
}
setInterval(req, 500);
req();

window.addEventListener("beforeunload", function() {
	navigator.sendBeacon("/api/" + roomId + "/leave?key=" + userId, null);
});
		</script>
	</body>
</html>
